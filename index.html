<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Reset Gawai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .submit-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            transition: all 0.3s ease;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }
        .submit-btn:disabled {
            background: #cccccc !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }
        .next-btn {
            background: linear-gradient(45deg, #2563eb, #1d4ed8);
            transition: all 0.3s ease;
        }
        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }
        .back-btn {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(107, 114, 128, 0.3);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .success-message {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .error-message {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .page-transition {
            transition: all 0.3s ease-in-out;
        }
        #signatureCanvas {
            background: white;
            border: 2px solid #d1d5db;
        }
        .signature-display {
            max-width: 150px;
            max-height: 75px;
            border: 1px solid #ccc;
            background: white;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen py-8 px-4">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">FORMULIR RESET GAWAI</h1>
            <div class="w-24 h-1 bg-white mx-auto rounded-full opacity-80"></div>
        </div>

        <!-- Page 1: Data Diri -->
        <div id="page1" class="page active page-transition">
            <div class="glass-effect rounded-2xl p-8 shadow-2xl">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white mb-2">Data Diri Pegawai</h2>
                    <p class="text-white/80">Silakan lengkapi data diri Anda terlebih dahulu</p>
                </div>

                <form id="dataForm" class="space-y-6">
                    <!-- Nama -->
                    <div class="form-group">
                        <label for="nama" class="block text-white font-medium mb-2">Nama Lengkap</label>
                        <input type="text" id="nama" name="nama" required
                               class="form-input w-full px-4 py-3 rounded-lg border-0 bg-white/90 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300"
                               placeholder="Masukkan nama lengkap">
                    </div>

                    <!-- NIP -->
                    <div class="form-group">
                        <label for="nip" class="block text-white font-medium mb-2">NIP</label>
                        <input type="text" id="nip" name="nip" required
                               class="form-input w-full px-4 py-3 rounded-lg border-0 bg-white/90 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300"
                               placeholder="Masukkan NIP">
                    </div>

                    <!-- Satker -->
                    <div class="form-group">
                        <label for="satker" class="block text-white font-medium mb-2">Satuan Kerja</label>
                        <select id="satker" name="satker" required
                                class="form-input w-full px-4 py-3 rounded-lg border-0 bg-white/90 text-gray-800 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300">
                            <option value="">Pilih Satuan Kerja</option>
                            <option value="Direktorat Keuangan">Direktorat Keuangan</option>
                            <option value="Direktorat Pengembangan dan Usaha">Direktorat Pengembangan dan Usaha</option>
                            <option value="Direktorat Program dan Berita">Direktorat Program dan Berita</option>
                            <option value="Direktorat Teknik">Direktorat Teknik</option>
                            <option value="Direktorat Umum">Direktorat Umum</option>
                            <option value="Pusat Data dan Strategi">Pusat Data dan Strategi</option>
                            <option value="Pusat Pendidikan dan Pelatihan">Pusat Pendidikan dan Pelatihan</option>
                            <option value="Satuan Pengawasan Intern">Satuan Pengawasan Intern</option>
                            <option value="TVRI Stasiun Aceh">TVRI Stasiun Aceh</option>
                            <option value="TVRI Stasiun Bali">TVRI Stasiun Bali</option>
                            <option value="TVRI Stasiun Bangka Belitung">TVRI Stasiun Bangka Belitung</option>
                            <option value="TVRI Stasiun Bengkulu">TVRI Stasiun Bengkulu</option>
                            <option value="TVRI Stasiun D.I. Yogyakarta">TVRI Stasiun D.I. Yogyakarta</option>
                            <option value="TVRI Stasiun DKI Jakarta">TVRI Stasiun DKI Jakarta</option>
                            <option value="TVRI Stasiun Gorontalo">TVRI Stasiun Gorontalo</option>
                            <option value="TVRI Stasiun Jambi">TVRI Stasiun Jambi</option>
                            <option value="TVRI Stasiun Jawa Barat">TVRI Stasiun Jawa Barat</option>
                            <option value="TVRI Stasiun Jawa Tengah">TVRI Stasiun Jawa Tengah</option>
                            <option value="TVRI Stasiun Jawa Timur">TVRI Stasiun Jawa Timur</option>
                            <option value="TVRI Stasiun Kalimantan Barat">TVRI Stasiun Kalimantan Barat</option>
                            <option value="TVRI Stasiun Kalimantan Selatan">TVRI Stasiun Kalimantan Selatan</option>
                            <option value="TVRI Stasiun Kalimantan Tengah">TVRI Stasiun Kalimantan Tengah</option>
                            <option value="TVRI Stasiun Kalimantan Timur">TVRI Stasiun Kalimantan Timur</option>
                            <option value="TVRI Stasiun Kalimantan Utara">TVRI Stasiun Kalimantan Utara</option>
                            <option value="TVRI Stasiun Kepulauan Riau">TVRI Stasiun Kepulauan Riau</option>
                            <option value="TVRI Stasiun Lampung">TVRI Stasiun Lampung</option>
                            <option value="TVRI Stasiun Maluku">TVRI Stasiun Maluku</option>
                            <option value="TVRI Stasiun NTB">TVRI Stasiun NTB</option>
                            <option value="TVRI Stasiun NTT">TVRI Stasiun NTT</option>
                            <option value="TVRI Stasiun Papua">TVRI Stasiun Papua</option>
                            <option value="TVRI Stasiun Papua Barat">TVRI Stasiun Papua Barat</option>
                            <option value="TVRI Stasiun Riau">TVRI Stasiun Riau</option>
                            <option value="TVRI Stasiun Sulawesi Barat">TVRI Stasiun Sulawesi Barat</option>
                            <option value="TVRI Stasiun Sulawesi Selatan">TVRI Stasiun Sulawesi Selatan</option>
                            <option value="TVRI Stasiun Sulawesi Tengah">TVRI Stasiun Sulawesi Tengah</option>
                            <option value="TVRI Stasiun Sulawesi Tenggara">TVRI Stasiun Sulawesi Tenggara</option>
                            <option value="TVRI Stasiun Sulawesi Utara">TVRI Stasiun Sulawesi Utara</option>
                            <option value="TVRI Stasiun Sumatera Barat">TVRI Stasiun Sumatera Barat</option>
                            <option value="TVRI Stasiun Sumatera Selatan">TVRI Stasiun Sumatera Selatan</option>
                            <option value="TVRI Stasiun Sumatera Utara">TVRI Stasiun Sumatera Utara</option>
                        </select>
                    </div>

                    <!-- Tanggal -->
                    <div class="form-group">
                        <label for="tanggal" class="block text-white font-medium mb-2">Tanggal</label>
                        <input type="date" id="tanggal" name="tanggal" required
                               class="form-input w-full px-4 py-3 rounded-lg border-0 bg-white/90 text-gray-800 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300">
                    </div>

                    <!-- Alasan -->
                    <div class="form-group">
                        <label for="alasan" class="block text-white font-medium mb-2">Alasan Reset Gawai</label>
                        <textarea id="alasan" name="alasan" required rows="4"
                                  class="form-input w-full px-4 py-3 rounded-lg border-0 bg-white/90 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300 resize-none"
                                  placeholder="Masukkan alasan reset gawai"></textarea>
                    </div>

                    <!-- Upload File -->
                    <div class="form-group">
                        <label for="fileUpload" class="block text-white font-medium mb-2">Upload Dokumen Pendukung (Opsional)</label>
                        <div class="relative">
                            <input type="file" id="fileUpload" name="fileUpload" accept=".pdf,.jpg,.jpeg,.png"
                                   class="form-input w-full px-4 py-3 rounded-lg border-0 bg-white/90 text-gray-800 focus:outline-none focus:ring-2 focus:ring-white/50 transition-all duration-300">
                            <p class="text-white/70 text-sm mt-2">Format: PDF, JPG, PNG | Maksimal: 10MB</p>
                        </div>
                        <div id="fileStatus" class="mt-2 text-sm"></div>
                    </div>

                    <!-- Tanda Tangan -->
                    <div class="form-group">
                        <label class="block text-white font-medium mb-2">Tanda Tangan Digital</label>
                        <div class="bg-white/90 rounded-lg p-4">
                            <canvas id="signatureCanvas" width="400" height="200" 
                                    class="border-2 border-gray-300 rounded cursor-crosshair w-full"
                                    style="max-width: 100%; height: 150px;"></canvas>
                            <div class="flex gap-2 mt-3">
                                <button type="button" id="clearSignature"
                                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                    Hapus
                                </button>
                            </div>
                            <p class="text-gray-600 text-sm mt-2">Gambar tanda tangan Anda di area putih di atas</p>
                        </div>
                    </div>

                    <!-- Next Button -->
                    <div class="form-group pt-4">
                        <button type="button" id="nextBtn"
                                class="next-btn w-full py-4 px-6 rounded-lg text-white font-semibold text-lg shadow-lg">
                            Lanjut ke Surat Pernyataan →
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Page 2: Surat Pernyataan -->
        <div id="page2" class="page page-transition">
            <div class="glass-effect rounded-2xl p-8 shadow-2xl">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white mb-2">Surat Pernyataan</h2>
                    <p class="text-white/80">Silakan baca dan setujui surat pernyataan berikut</p>
                </div>

                <!-- Surat Pernyataan -->
                <div class="bg-white/95 rounded-lg p-8 text-gray-800 text-sm leading-relaxed shadow-lg mb-6">
                    <div class="text-center mb-8">
                        <h3 class="font-bold text-lg text-blue-800 mb-4">SURAT PERNYATAAN RESET/PERUBAHAN GAWAI</h3>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="mb-6">
                            <p class="mb-4">Yang bertanda tangan di bawah ini:</p>
                            <div class="space-y-2">
                                <p>Nama : <span class="font-medium" id="suratNama">-</span></p>
                                <p>NIP : <span class="font-medium" id="suratNip">-</span></p>
                                <p>Satuan Kerja : <span class="font-medium" id="suratSatker">-</span></p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <p>Dengan ini mengajukan permohonan perubahan gawai/perangkat dikarenakan <span class="font-medium" id="suratAlasan">-</span></p>
                        </div>
                        
                        <div class="mb-8">
                            <p>Demikian Surat Pernyataan ini saya buat dengan sesungguhnya, dan apabila dikemudian hari ditemukan bahwa Surat Pernyataan ini tidak benar, maka saya siap menerima sanksi sesuai ketentuan yang berlaku.</p>
                        </div>
                        
                        <div class="flex justify-end mt-12">
                            <div class="text-left">
                                <p class="mb-2"><span class="font-medium" id="suratTanggal">-</span></p>
                                <p class="mb-4">Hormat Saya,</p>
                                <div class="mb-4">
                                    <img id="signatureDisplay" class="signature-display" style="display: none;" alt="Tanda Tangan">
                                </div>
                                <div>
                                    <p class="font-medium" id="suratNamaTtd">-</p>
                                    <p class="font-medium" id="suratNipTtd">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkbox Setuju -->
                <div class="form-group mb-6">
                    <div class="flex items-start">
                        <input type="checkbox" id="setuju" name="setuju" required
                               class="w-5 h-5 text-blue-600 bg-white/90 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 mt-1">
                        <label for="setuju" class="ml-3 text-white font-medium">
                            Saya telah membaca dan memahami surat pernyataan di atas, serta menyetujui semua ketentuan yang berlaku untuk proses reset gawai ini.
                        </label>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-4">
                    <button type="button" id="backBtn"
                            class="back-btn flex-1 py-4 px-6 rounded-lg text-white font-semibold text-lg shadow-lg">
                        ← Kembali
                    </button>
                    <button type="button" id="submitBtn" disabled
                            class="flex-1 py-4 px-6 rounded-lg text-white font-semibold text-lg shadow-lg opacity-50 cursor-not-allowed"
                            style="background: #cccccc;">
                        <span id="submitText">Kirim Formulir</span>
                        <span id="loadingSpinner" class="loading hidden"></span>
                    </button>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8">
            <p class="text-white font-semibold text-lg">LPP TVRI</p>
            <p class="text-white font-semibold text-lg">2025</p>
        </div>
    </div>

    <script>
        // Set tanggal hari ini sebagai default
        document.getElementById('tanggal').valueAsDate = new Date();

        // Signature Canvas Setup
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let signatureData = [];
        let currentStroke = [];

        // Set canvas size properly
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Mouse events for signature
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events for mobile
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            currentStroke = [];
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width) / 2;
            const y = (e.clientY - rect.top) * (canvas.height / rect.height) / 2;
            ctx.beginPath();
            ctx.moveTo(x, y);
            currentStroke.push({x, y});
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width) / 2;
            const y = (e.clientY - rect.top) * (canvas.height / rect.height) / 2;
            ctx.lineTo(x, y);
            ctx.stroke();
            currentStroke.push({x, y});
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                signatureData.push([...currentStroke]);
                currentStroke = [];
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        // Clear signature
        document.getElementById('clearSignature').addEventListener('click', function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureData = [];
        });

        function redrawSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureData.forEach(stroke => {
                if (stroke.length > 0) {
                    ctx.beginPath();
                    ctx.moveTo(stroke[0].x, stroke[0].y);
                    stroke.forEach(point => {
                        ctx.lineTo(point.x, point.y);
                    });
                    ctx.stroke();
                }
            });
        }

        // File upload validation
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileStatus = document.getElementById('fileStatus');
            
            if (file) {
                const maxSize = 10 * 1024 * 1024; // 10MB
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                
                if (file.size > maxSize) {
                    fileStatus.innerHTML = '<span class="text-red-300">❌ File terlalu besar! Maksimal 10MB</span>';
                    e.target.value = '';
                    return;
                }
                
                if (!allowedTypes.includes(file.type)) {
                    fileStatus.innerHTML = '<span class="text-red-300">❌ Format file tidak didukung! Gunakan PDF, JPG, atau PNG</span>';
                    e.target.value = '';
                    return;
                }
                
                fileStatus.innerHTML = `<span class="text-green-300">✅ File "${file.name}" berhasil dipilih (${(file.size/1024/1024).toFixed(2)} MB)</span>`;
            }
        });

        // Navigation functions
        function showPage(pageNumber) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`page${pageNumber}`).classList.add('active');
        }

        // Next button functionality
        document.getElementById('nextBtn').addEventListener('click', function() {
            const form = document.getElementById('dataForm');
            if (form.checkValidity()) {
                // Check if signature exists
                if (signatureData.length === 0) {
                    alert('Silakan buat tanda tangan terlebih dahulu!');
                    return;
                }
                
                // Fill the letter with form data
                fillLetter();
                showPage(2);
            } else {
                form.reportValidity();
            }
        });

        // Back button functionality
        document.getElementById('backBtn').addEventListener('click', function() {
            showPage(1);
        });

        // Fill letter with form data
        function fillLetter() {
            const nama = document.getElementById('nama').value;
            const nip = document.getElementById('nip').value;
            const satker = document.getElementById('satker').value;
            const tanggal = document.getElementById('tanggal').value;
            const alasan = document.getElementById('alasan').value;

            // Format tanggal
            const dateObj = new Date(tanggal);
            const formattedDate = dateObj.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Fill letter fields
            document.getElementById('suratNama').textContent = nama;
            document.getElementById('suratNip').textContent = nip;
            document.getElementById('suratSatker').textContent = satker;
            document.getElementById('suratTanggal').textContent = formattedDate;
            document.getElementById('suratAlasan').textContent = alasan;
            document.getElementById('suratNamaTtd').textContent = nama;
            document.getElementById('suratNipTtd').textContent = nip;

            // Display signature
            const signatureDisplay = document.getElementById('signatureDisplay');
            if (signatureData.length > 0) {
                signatureDisplay.src = canvas.toDataURL();
                signatureDisplay.style.display = 'block';
            }

            // PENTING: Reset checkbox dan disable tombol submit saat pindah ke halaman 2
            document.getElementById('setuju').checked = false;
            checkSubmitButton();
        }

        // Function to check if submit button should be enabled
        function checkSubmitButton() {
            const setujuCheckbox = document.getElementById('setuju');
            const submitBtn = document.getElementById('submitBtn');
            
            if (setujuCheckbox.checked) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.add('submit-btn');
                submitBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                submitBtn.classList.remove('submit-btn');
                submitBtn.style.background = '#cccccc';
            }
        }

        // Add event listener to checkbox
        document.getElementById('setuju').addEventListener('change', checkSubmitButton);

        // Function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Function to generate PDF from the letter
        async function generatePDF() {
            return new Promise((resolve) => {
                // Create a temporary container for PDF generation
                const pdfContainer = document.createElement('div');
                pdfContainer.style.cssText = `
                    position: absolute;
                    top: -9999px;
                    left: -9999px;
                    width: 180mm;
                    background: white;
                    padding: 15mm;
                    font-family: 'Times New Roman', serif;
                    font-size: 11pt;
                    line-height: 1.4;
                    color: black;
                `;

                // Get form data
                const nama = document.getElementById('nama').value;
                const nip = document.getElementById('nip').value;
                const satker = document.getElementById('satker').value;
                const tanggal = document.getElementById('tanggal').value;
                const alasan = document.getElementById('alasan').value;

                // Format tanggal
                const dateObj = new Date(tanggal);
                const formattedDate = dateObj.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                // Create letter HTML
                pdfContainer.innerHTML = `
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h2 style="margin: 0; font-size: 14pt; font-weight: bold;">SURAT PERNYATAAN RESET/PERUBAHAN GAWAI</h2>
                    </div>
                    
                    <div style="margin-bottom: 18px;">
                        <p style="margin-bottom: 12px;">Yang bertanda tangan di bawah ini:</p>
                        <div style="margin-left: 18px; margin-bottom: 18px;">
                            <p style="margin: 4px 0;">Nama : <strong>${nama}</strong></p>
                            <p style="margin: 4px 0;">NIP : <strong>${nip}</strong></p>
                            <p style="margin: 4px 0;">Satuan Kerja : <strong>${satker}</strong></p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 18px;">
                        <p>Dengan ini mengajukan permohonan perubahan gawai/perangkat dikarenakan <strong>${alasan}</strong></p>
                    </div>
                    
                    <div style="margin-bottom: 35px;">
                        <p>Demikian Surat Pernyataan ini saya buat dengan sesungguhnya, dan apabila dikemudian hari ditemukan bahwa Surat Pernyataan ini tidak benar, maka saya siap menerima sanksi sesuai ketentuan yang berlaku.</p>
                    </div>
                    
                    <div style="text-align: right; margin-top: 35px;">
                        <div style="display: inline-block; text-align: left;">
                            <p style="margin: 4px 0;">${formattedDate}</p>
                            <p style="margin: 4px 0 12px 0;">Hormat Saya,</p>
                            <div style="margin: 12px 0; height: 60px; display: flex; align-items: center;">
                                <img src="${canvas.toDataURL()}" style="max-width: 100px; max-height: 50px;" alt="Tanda Tangan">
                            </div>
                            <div>
                                <p style="margin: 4px 0; font-weight: bold;">${nama}</p>
                                <p style="margin: 4px 0; font-weight: bold;">${nip}</p>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(pdfContainer);

                // Use html2canvas to convert to image, then to PDF
                html2canvas(pdfContainer, {
                    scale: 1.2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: pdfContainer.offsetWidth,
                    height: pdfContainer.offsetHeight
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Create PDF using jsPDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4', true);
                    
                    const imgWidth = 180;
                    const pageHeight = 250;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 10;

                    pdf.addImage(imgData, 'JPEG', 15, position, imgWidth, imgHeight, undefined, 'FAST');
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 15, position, imgWidth, imgHeight, undefined, 'FAST');
                        heightLeft -= pageHeight;
                    }

                    document.body.removeChild(pdfContainer);
                    resolve(pdf.output('datauristring'));
                });
            });
        }

        // Handle form submission
        document.getElementById('submitBtn').addEventListener('click', async function() {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const statusMessage = document.getElementById('statusMessage');
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitText.textContent = 'Mengirim Formulir...';
            loadingSpinner.classList.remove('hidden');
            statusMessage.innerHTML = '';
            
            try {
                // Prepare all data
                const basicData = {
                    timestamp: new Date().toLocaleString('id-ID'),
                    nama: document.getElementById('nama').value,
                    nip: document.getElementById('nip').value,
                    satker: document.getElementById('satker').value,
                    tanggal: document.getElementById('tanggal').value,
                    alasan: document.getElementById('alasan').value,
                    setuju: document.getElementById('setuju').checked ? 'Ya' : 'Tidak'
                };

                // Generate PDF
                const pdfData = await generatePDF();

                // Prepare file data (if any)
                let fileData = null;
                let fileName = null;
                let fileType = null;
                
                const fileInput = document.getElementById('fileUpload');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    fileData = await fileToBase64(file);
                    fileName = file.name;
                    fileType = file.type;
                }

                // Send all data in one request
                const allData = {
                    ...basicData,
                    pdfData: pdfData,
                    fileData: fileData,
                    fileName: fileName,
                    fileType: fileType
                };

                const response = await fetch('https://script.google.com/macros/s/AKfycbx523T0BNyoYQNUqR-ih6Enn1kuzYdSSJ96TP36fSDJJPSdz2MeVIOG-ntsOfHqZAw7/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(allData)
                });

                statusMessage.innerHTML = '<div class="success-message">✅ Formulir berhasil dikirim! Data dan file telah tersimpan.</div>';
                
                // Reset forms and go back to page 1
                setTimeout(() => {
                    document.getElementById('dataForm').reset();
                    document.getElementById('tanggal').valueAsDate = new Date();
                    document.getElementById('setuju').checked = false;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    signatureData = [];
                    document.getElementById('fileStatus').innerHTML = '';
                    showPage(1);
                    statusMessage.innerHTML = '';
                }, 5000);
                
            } catch (error) {
                console.error('Error:', error);
                statusMessage.innerHTML = '<div class="error-message">❌ Gagal memproses data. Error: ' + error.message + '</div>';
            }
            
            // Reset button
            submitBtn.disabled = false;
            submitText.textContent = 'Kirim Formulir';
            loadingSpinner.classList.add('hidden');
            checkSubmitButton();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9725f0582445f914',t:'MTc1NTczNTM1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
